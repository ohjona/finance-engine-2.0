---
id: v2_architecture_roadmap
type: strategy
status: active
depends_on:
  - PRD_v2
  - institutional_knowledge_compendium
---

# Finance Engine v2.0 Architecture Roadmap

**Version:** 2.2
**Date:** January 31, 2026
**Author:** Gemini CLI, powered by Gemini 2.5 Pro + Jonathan Oh
**Status:** Active — Aligned with PRD v2.2 and IK v1.2

---

## Executive Summary

Finance Engine v1.x (Python) served as a validated prototype, proving out:
- Multi-source parsing (Amex, Chase, BoA, Fidelity, Discover)
- 3-layer categorization hierarchy (user → base → bank)
- Payment matching and double-entry generation
- LLM-assisted categorization (Phase B)

**v2.0 rewrites the core in TypeScript** to enable:
- Browser-native execution (no server required for processing)
- Cross-platform CLI (Node.js)
- Future desktop/mobile apps from a single codebase
- Client-side processing for privacy

---

## 1. Strategic Context

### 1.1 Why Rewrite in TypeScript?

| Factor | Python v1.x | TypeScript v2.0 |
|--------|-------------|-----------------|
| Browser execution | WASM hacks (slow cold start) | Native |
| CLI support | ✓ | ✓ (Node.js) |
| Desktop app | Bundled Python (heavy) | Electron (standard) |
| Mobile | Not viable | React Native |
| Codebase | ~2k LOC | One codebase, all platforms |

### 1.2 What We Preserve

The [PRD v2.2](finance-engine-2.0-PRD.md) remains the **source of truth** for business logic:
- Data structures (Normalized Transaction, Journal Entry)
- 4-layer categorization logic (User → Shared → Base → Bank)
- Payment matching configuration
- Run safety (hash-based dedup, manifest, overwrite protection) — see [IK D8.2](institutional-knowledge.md#d82-run-manifest) for manifest schema
- Output schemas (journal.xlsx, review.xlsx, analysis.xlsx)

We are **changing the implementation language**, not the product requirements.

### 1.3 What We Change

| Area | v1.x | v2.0 |
|------|------|------|
| Language | Python | TypeScript |
| Distribution | `pip install` / scripts | npm package + web bundle |
| Workspace | Hardcoded `imports/` etc. | Configurable workspace root |
| Rules hierarchy | 3-layer (user, base, bank) | 4-layer (user, shared, base, bank) |
| LLM | Optional (BYOT) | Same, but refactored |

---

## 2. Target Architecture

### 2.1 Package Structure

```
finance-engine/
├── packages/
│   ├── core/                 # Pure TypeScript engine (no I/O)
│   │   ├── src/
│   │   │   ├── parser/       # Parser implementations
│   │   │   ├── categorizer/  # 4-layer categorization
│   │   │   ├── matcher/      # Payment matching
│   │   │   ├── ledger/       # Double-entry generation
│   │   │   └── types/        # Data structures
│   │   └── package.json
│   │
│   ├── cli/                  # Node.js CLI wrapper
│   │   ├── src/
│   │   │   └── index.ts
│   │   └── package.json
│   │
│   ├── web/                  # Browser / PWA frontend
│   │   ├── src/
│   │   │   └── App.tsx
│   │   └── package.json
│   │
│   └── shared/               # Config schemas, constants
│       └── package.json
│
├── docker-compose.yml        # Full stack for self-hosters
├── deploy/                   # Hosting scripts (Fly.io, Railway)
└── docs/                     # Existing docs (preserved)
```

### 2.2 Core Package Design

The `@finance-engine/core` package is **headless** (no I/O):

```typescript
// Pure functions, no side effects
export function parseAmex(data: ArrayBuffer, accountId: number): Transaction[];
export function categorize(txn: Transaction, rules: RuleSet): CategorizedTransaction;
export function matchPayments(txns: Transaction[], config: MatchConfig): Match[];
export function generateJournal(txns: CategorizedTransaction[]): JournalEntry[];
```

I/O is handled by the consuming layer (CLI reads files, web reads from IndexedDB or uploads).

**Serialization Boundary (per IK A12.8):**

| Operation | Responsibility | Location |
|-----------|----------------|----------|
| Parse YAML rules | CLI/Web | `@finance-engine/cli` |
| Read config files | CLI/Web | `@finance-engine/cli` |
| Write updated rules | CLI/Web | `@finance-engine/cli` |
| YAML round-trip preservation | CLI/Web | Use `yaml.parseDocument()` |
| Rule mutation helpers | Core | Pure `RuleSet → RuleSet` transforms |

This ensures core package has no `fs` dependency and can run in browser.

### 2.3 Workspace Model

```typescript
interface Workspace {
  root: string;           // e.g., "~/Finance/2025/"
  imports: string;        // defaults to "${root}/imports/"
  outputs: string;        // defaults to "${root}/outputs/"
  archive: string;        // defaults to "${root}/archive/"
  config: WorkspaceConfig;
}

interface WorkspaceConfig {
  userRulesPath: string;    // path to user-rules.yaml (personal overrides)
  baseRulesPath: string;    // path to base-rules.yaml (user's general patterns)
  accountsPath: string;     // path to chart of accounts
  llmProvider?: LLMConfig;  // optional LLM for categorization
}
```

CLI auto-detects workspace by looking for `config/user-rules.yaml` in current or parent directories.

**Deterministic Processing (per IK D2.12-D2.13):**
- Files processed in lexicographic (ASCII byte order) sort for reproducible collision suffixes (`-02`, `-03`)
- txn_id payload uses `raw_description` (no normalization before hash) for stable IDs across bank format changes
- Pattern matching still uses normalized description; hashing does not
- See [IK D2.12](institutional-knowledge.md#d212-txn_id-payload-normalization) for full normalization spec

---

## 3. Rules Hierarchy (Revised)

### 3.1 Four-Layer Model

| Priority | Layer | Confidence | Source |
|----------|-------|------------|--------|
| 1 (highest) | User Rules | 1.0 | `user-rules.yaml` (personal overrides) |
| 2 | Shared Standard | 0.9 | `shared-rules.yaml` (bundled, maintainer curated) |
| — | *LLM-approved rules* | *0.85* | *Rules confirmed by human after LLM suggestion* |
| 3 | Base Rules | 0.8 | `base-rules.yaml` (user's general patterns) |
| — | *LLM inference* | *0.7* | *Uncategorized transactions processed by LLM* |
| 4 | Bank Category | 0.6 | Raw category from bank export |
| — | *UNCATEGORIZED* | *0.3* | *Fallback when all layers fail* |

> **Note:** LLM rows show confidence values for optional LLM integration, not additional rule layers. The 4-layer model refers to: User → Shared → Base → Bank.

> **Note on 4999:** `4999 UNCATEGORIZED` is a sentinel indicating categorization failure. After review, no transactions should remain at 4999. It is visually distinct from `4990 Miscellaneous` (an intentional category).

### 3.2 Matching Logic

```typescript
function categorize(txn: Transaction, rules: RuleSet): CategorizedTransaction {
  // Layer 1: User rules (highest priority)
  const userMatch = matchRules(txn, rules.user_rules);
  if (userMatch) return { ...txn, ...userMatch, confidence: 1.0, source: 'user' };

  // Layer 2: Shared standard (bundled)
  const sharedMatch = matchRules(txn, rules.shared_rules);
  if (sharedMatch) return { ...txn, ...sharedMatch, confidence: 0.9, source: 'shared' };

  // Layer 3: Base rules (user's general patterns)
  const baseMatch = matchRules(txn, rules.base_rules);
  if (baseMatch) return { ...txn, ...baseMatch, confidence: 0.8, source: 'base' };

  // Layer 4: Bank category (from raw_category) or uncategorized
  const bankMatch = matchBankCategory(txn);
  return { ...txn, ...bankMatch, confidence: bankMatch ? 0.6 : 0.3, source: bankMatch ? 'bank' : 'uncategorized' };
}
```

### 3.3 Rule Files Structure

For v2.0, rules are split into three files:

| File | Location | Purpose |
|------|----------|---------|
| `user-rules.yaml` | Workspace `config/` | Personal overrides (highest priority) |
| `shared-rules.yaml` | Bundled with CLI | Universal patterns (AMAZON, UBER, etc.) |
| `base-rules.yaml` | Workspace `config/` | User's general patterns |

**Migration from v1.x:** If migrating from Python v1.x `rules.yaml`:
1. **Audit current rules**: Identify universally applicable patterns
2. **Split into**:
   - `user-rules.yaml` (personal): "COSTCO → Groceries" (your specific usage)
   - `base-rules.yaml` (general): Your common vendor patterns

### 3.4 Pattern Matching

```typescript
interface Rule {
  pattern: string;
  pattern_type?: 'substring' | 'regex';  // Default: substring
  category_id: number;
  note?: string;
}
```

**Rule ordering:** More specific patterns must appear before general patterns (e.g., "UBER EATS" before "UBER"). See [IK D4.5](institutional-knowledge.md#d45-rule-ordering) for the "UBER shadowed by UBER EATS" lesson.

**Regex handling:** Invalid regex patterns are caught and logged; the rule is skipped. See [PRD Section 9.2](finance-engine-2.0-PRD.md#92-implementation) for implementation.

## 4. Distribution Model

### 4.1 For Developers / Power Users

```bash
# Clone the monorepo
git clone https://github.com/ohjonathan/finance-engine.git
cd finance-engine

# Install dependencies
npm install

# Run CLI from source
npx fineng process 2025-01 --workspace ~/Finance/2025
```

### 4.2 For Self-Hosters

```bash
# Clone and run full stack
git clone https://github.com/ohjonathan/finance-engine.git
cd finance-engine
docker-compose up -d

# Access web UI at http://localhost:3000
```

### 4.3 For Non-Technical Users (Future)

- Hosted web app at `fineng.your-domain.com`
- Processing happens in browser (client-side)
- No data leaves user's machine

---

## 5. Privacy-First Design

### 5.1 Client-Side Processing

All transaction parsing, categorization, and journal generation happens in the browser or on the user's machine. The server (if any) only provides:

- Static assets (JS/CSS)
- Shared rules distribution

> **Note:** Telemetry is **off by default**. User must explicitly opt in. User rules repositories must be private (vendor names reveal shopping habits). Shared rules are curated and can be public. See [PRD Section 1.5](finance-engine-2.0-PRD.md#15-privacy-first-design).

### 5.2 Telemetry (Anonymized, Opt-In)

| Data Collected | Purpose | NOT Collected |
|----------------|---------|---------------|
| Category usage frequency | Improve shared rules | Transaction amounts |
| Rule match rates | Identify gaps | Descriptions |
| Error types | Debug issues | Account IDs |

### 5.3 Rule Suggestion Pipeline

```
User categorizes "WARBY PARKER" → 4550 (Vision)
    ↓
Client: "Would you like to suggest this as a shared rule?"
    ↓
If yes: Submit anonymized pattern ("WARBY PARKER" → "Vision")
    ↓
Server: Aggregate suggestions, curate into shared-rules.yaml
    ↓
Next release: All users benefit
```

> **Governance:** See [IK D10.9](institutional-knowledge.md#d109-shared-rules-governance-v20) for curation policy. Only universal patterns (AMAZON, UBER, STARBUCKS) are included; regional/niche vendors are excluded.

---

## 6. LLM Integration (BYOT)

### 6.1 Provider Support

| Provider | Mechanism |
|----------|-----------|
| OpenAI | API key (user-provided) |
| Gemini | API key (user-provided) |
| Anthropic | API key (user-provided) |
| Ollama | Local server (user-hosted) |

### 6.2 Graceful Degradation

```typescript
async function categorizeWithLLM(txn: Transaction, llmConfig?: LLMConfig): Promise<Category | null> {
  if (!llmConfig) return null; // Fall back to regex-only

  try {
    const result = await callLLM(llmConfig, formatPrompt(txn));
    return parseResponse(result);
  } catch (e) {
    console.warn('LLM unavailable, using fallback');
    return null;
  }
}
```

### 6.3 Cost Visibility

The UI should display:
- Estimated tokens per run
- Cumulative usage for the session
- Cost estimate (based on provider pricing)

### 6.4 LLM Workflow

| Feature | Requirement |
|---------|-------------|
| Human-in-the-loop | NO auto-approval. User confirms each LLM suggestion. |
| Approval modes | `--interactive` (prompt each), `--export-only` (write review file) |
| Batch processing | Max 50 transactions per LLM call |
| Failure isolation | LLM errors never crash core pipeline; fall back to rules |
| Approved rule confidence | 0.85 (after human confirmation) |

> **For detailed LLM decisions (14 total), see [Institutional Knowledge, Section 5](institutional-knowledge.md#5-llm-integration).**

---

## 7. Error Handling

**Philosophy:** Skip and warn, then prompt.

> Collect all errors during parsing, then prompt user to continue or abort. Use `--yes` flag for non-interactive/CI mode.

See [PRD Section 11.3](finance-engine-2.0-PRD.md#113-error-handling) for implementation details.

---

## 8. Sync Strategy

### 8.1 Phased Rollout

| Stage | Data Location | Sync Mechanism |
|-------|---------------|----------------|
| v2.0 | Fully local | None (each device independent) |
| v2.1 | Local + cloud backup | User syncs via iCloud/Dropbox (point workspace at synced folder) |
| v2.2 (future) | Local + server sync | Encrypted server storage, client-side decryption |

### 8.2 Conflict Resolution

For v2.1 (cloud folder sync), use filesystem timestamps. For v2.2 (server sync), use vector clocks or CRDTs for rule merging.

---

## 9. Migration Path

### 9.1 From Python v1.x

Users can continue using v1.x indefinitely. v2.0 is a parallel product, not a breaking upgrade.

**Data compatibility:**
- Rule schema is preserved, split across `user-rules.yaml`, `shared-rules.yaml`, `base-rules.yaml`
- `accounts.json` format is preserved
- Output schemas (xlsx) are identical

### 9.2 Archive Current Python Codebase

The existing `finance-engine` repo becomes:
- Read-only archive (tag `v1.x-python-archive`)
- Documentation and specs preserved
- New TypeScript implementation in same or new repo (TBD)

---

## 10. Open Questions

### 10.1 For Reviewboard

1. **Repo structure**: New repo (`finance-engine-v2`) or replace current?
2. ~~**Shared rules governance**: How do we review community suggestions?~~ → Resolved: [IK D10.9](institutional-knowledge.md#d109-shared-rules-governance-v20) defines maintainer curation policy
3. **Excel output**: Use `xlsx` JS library or convert to ODS/CSV for browser?
4. **Priority**: CLI-first or Web-first for v2.0 MVP?

### 10.2 Dependencies

Proposed TypeScript dependencies:

| Library | Purpose |
|---------|---------|
| `xlsx` or `exceljs` | Excel parsing/writing |
| `date-fns` | Date manipulation (avoids JS Date quirks) |
| `decimal.js` | Arbitrary precision arithmetic |
| `yaml` | YAML parsing |
| `zod` | Runtime type validation |

---

## 11. Next Steps

1. ~~**Reviewboard discussion**: Align on open questions~~ → Resolved
2. ~~**PRD v2.0**: Update PRD with TypeScript-specific decisions~~ → ✅ Done
3. **Scaffold monorepo**: Set up `packages/` structure with build tooling
4. **Port core logic**: Translate Python → TypeScript (parser by parser)
5. **CLI MVP**: Ship CLI before web UI
6. **Web MVP**: Simple upload → process → download flow

> **Implementation Notes:** See [Institutional Knowledge Compendium, Section 11](institutional-knowledge.md#11-implementation-lessons) for lessons learned from v1.x development.

---

## Document History

| Version | Date | Changes |
|---------|------|---------|
| 2.0-draft | 2026-01-26 | Initial architecture roadmap from discussion |
| 2.0 | 2026-01-27 | Review fixes: PRD v2.0 alignment, 4-layer model, pattern matching section, LLM workflow, error handling, privacy strengthening |
| 2.1 | 2026-01-31 | PRD v2.2/IK v1.2 alignment: Fixed 3-layer→4-layer references, workspace auto-detection marker updated to `user-rules.yaml`, rule files structure clarified, serialization boundary added, IK cross-references added |
| **2.2** | **2026-01-31** | **Codex review integration:** v1.x historical accuracy (3-layer), RuleSet naming alignment with PRD, section numbering fixes, privacy wording clarification, CLI command fix, LLM table clarification, IK dependency added |

---

*This document captures the architectural direction for Finance Engine v2.0. It is a living document aligned with [PRD v2.2](finance-engine-2.0-PRD.md) and [Institutional Knowledge v1.2](institutional-knowledge.md).*
