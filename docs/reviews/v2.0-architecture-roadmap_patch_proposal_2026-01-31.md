---
id: v20_architecture_roadmap_patch_proposal_2026_01_31
type: strategy
status: scaffold
ontos_schema: 2.2
curation_level: 0
generated_by: ontos_scaffold
---

# Patch Proposal: v2.0-architecture-roadmap.md (2026-01-31)

This patch resolves the inconsistencies and clarity issues identified in the review: version references, v1.x layer count, RuleSet naming, privacy wording, migration wording, section numbering, and dependency alignment. It also clarifies LLM-approved rules as a confidence attribute rather than a layer.

```diff
*** a/finance-engine-2.0/docs/v2.0-architecture-roadmap.md
--- b/finance-engine-2.0/docs/v2.0-architecture-roadmap.md
@@
 depends_on:
   - PRD_v2
+  - institutional_knowledge_compendium
@@
-Finance Engine v1.x (Python) served as a validated prototype, proving out:
+Finance Engine v1.x (Python) served as a validated prototype, proving out:
 - Multi-source parsing (Amex, Chase, BoA, Fidelity, Discover)
-- 4-layer categorization hierarchy
+- 3-layer categorization hierarchy
 - Payment matching and double-entry generation
 - LLM-assisted categorization (Phase B)
@@
-The [PRD v2.0](finance-engine-2.0-PRD.md) remains the **source of truth** for business logic:
+The [PRD v2.2](finance-engine-2.0-PRD.md) remains the **source of truth** for business logic:
@@
-| Rules hierarchy | 2-layer (user, base) | 4-layer (user, shared, base, bank) |
+| Rules hierarchy | 3-layer (user, base, bank) | 4-layer (user, shared, base, bank) |
@@
 interface WorkspaceConfig {
   userRulesPath: string;    // path to user-rules.yaml (personal overrides)
   baseRulesPath: string;    // path to base-rules.yaml (user's general patterns)
   accountsPath: string;     // path to chart of accounts
   llmProvider?: LLMConfig;  // optional LLM for categorization
 }
@@
-**Deterministic Processing (per IK D2.12-D2.13):**
+**Deterministic Processing (per IK D2.12-D2.13):**
 - Files processed in lexicographic (ASCII byte order) sort for reproducible collision suffixes (`-02`, `-03`)
-- txn_id payload uses raw description (no normalization before hash) for stable IDs across bank format changes
+- txn_id payload uses raw_description (no normalization before hash) for stable IDs across bank format changes
+- Matching still uses normalized description; hashing does not
 - See [IK D2.12](institutional-knowledge.md#d212-txn_id-payload-normalization) for full normalization spec
@@
-| Priority | Layer | Confidence | Source |
-|----------|-------|------------|--------|
-| 1 (highest) | User Rules | 1.0 | `user-rules.yaml` (personal overrides) |
-| 2 | Shared Standard | 0.9 | `shared-rules.yaml` (bundled, maintainer curated) |
-| — | *LLM-approved rules* | *0.85* | *Rules confirmed by human after LLM suggestion* |
-| 3 | Base Rules | 0.8 | `base-rules.yaml` (user's general patterns) |
-| — | *LLM inference* | *0.7* | *Uncategorized transactions processed by LLM* |
-| 4 | Bank Category | 0.6 | Raw category from bank export |
-| — | *UNCATEGORIZED* | *0.3* | *Fallback when all layers fail* |
+| Priority | Layer | Confidence | Source |
+|----------|-------|------------|--------|
+| 1 (highest) | User Rules | 1.0 | `user-rules.yaml` (personal overrides) |
+| 2 | Shared Standard | 0.9 | `shared-rules.yaml` (bundled, maintainer curated) |
+| 3 | Base Rules | 0.8 | `base-rules.yaml` (user's general patterns) |
+| 4 | Bank Category | 0.6 | Raw category from bank export |
+| — | *UNCATEGORIZED* | *0.3* | *Fallback when all layers fail* |
+
+**LLM notes:**
+- LLM-approved rules are stored in `user-rules.yaml` and use confidence 0.85 (not a separate layer).
+- Optional LLM inference applies only after rule layers fail; confidence 0.7 and always flagged for review.
@@
-function categorize(txn: Transaction, rules: RuleSet): CategorizedTransaction {
+function categorize(txn: Transaction, rules: RuleSet): CategorizedTransaction {
   // Layer 1: User rules (highest priority)
-  const userMatch = matchRules(txn, rules.user);
+  const userMatch = matchRules(txn, rules.user_rules);
   if (userMatch) return { ...txn, ...userMatch, confidence: 1.0, source: 'user' };
 
   // Layer 2: Shared standard (bundled)
-  const sharedMatch = matchRules(txn, rules.shared);
+  const sharedMatch = matchRules(txn, rules.shared_rules);
   if (sharedMatch) return { ...txn, ...sharedMatch, confidence: 0.9, source: 'shared' };
 
   // Layer 3: Base rules (user's general patterns)
-  const baseMatch = matchRules(txn, rules.base);
+  const baseMatch = matchRules(txn, rules.base_rules);
   if (baseMatch) return { ...txn, ...baseMatch, confidence: 0.8, source: 'base' };
 
   // Layer 4: Bank category or uncategorized
-  const bankMatch = matchWithFallback(txn, rules.system);
-  return { ...txn, ...bankMatch, confidence: bankMatch ? 0.6 : 0.3, source: bankMatch ? 'bank' : 'uncategorized' };
+  const bankMatch = matchWithFallback(txn);
+  return { ...txn, ...bankMatch, confidence: bankMatch ? 0.6 : 0.3, source: bankMatch ? 'bank' : 'uncategorized' };
 }
@@
-# Run CLI from source
-npx fineng run 2025-01 --workspace ~/Finance/2025
+# Run CLI from source
+npx fineng process 2025-01 --workspace ~/Finance/2025
@@
-> **Note:** Telemetry is **off by default**. User must explicitly opt in. Rules repository must be private (vendor names reveal shopping habits). See [PRD Section 1.5](finance-engine-2.0-PRD.md#15-privacy-first-design).
+> **Note:** Telemetry is **off by default**. User must explicitly opt in. User rules repositories must be private (vendor names reveal shopping habits). Shared rules are curated and can be public. See [PRD Section 1.5](finance-engine-2.0-PRD.md#15-privacy-first-design).
@@
-## 8. Sync Strategy
+## 8. Sync Strategy
 
-### 7.1 Phased Rollout
+### 8.1 Phased Rollout
@@
-| v2.2 | Local + server sync | Encrypted server storage, client-side decryption |
+| v2.2 (future) | Local + server sync | Encrypted server storage, client-side decryption |
@@
-### 7.2 Conflict Resolution
+### 8.2 Conflict Resolution
@@
-## 9. Migration Path
+## 9. Migration Path
 
-### 8.1 From Python v1.x
+### 9.1 From Python v1.x
@@
-**Data compatibility:**
-- `rules.yaml` format is preserved
+**Data compatibility:**
+- Rule schema is preserved, split across `user-rules.yaml`, `shared-rules.yaml`, `base-rules.yaml`
 - `accounts.json` format is preserved
 - Output schemas (xlsx) are identical
@@
-### 8.2 Archive Current Python Codebase
+### 9.2 Archive Current Python Codebase
@@
-## 10. Open Questions
+## 10. Open Questions
 
-### 9.1 For Reviewboard
+### 10.1 For Reviewboard
@@
-### 9.2 Dependencies
+### 10.2 Dependencies
```

Notes:
- If you prefer to keep the LLM inference row in the table, we can mark it explicitly as an “optional step” rather than a layer and add a note that it’s not part of the 4-layer hierarchy.
- If `matchWithFallback` must take a bank category map (e.g., `rules.bank_category_map`), we can wire that in instead of a zero-arg call; the key change is to avoid `rules.system` which doesn’t exist in PRD/IK.
